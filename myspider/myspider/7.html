<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <link rel="icon" href="https://jscdn.com.cn/highcharts/images/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* css 代码  */
    </style>
    <script src="https://img.hcharts.cn/jquery/jquery-1.8.3.min.js"></script>
    <script src="./highstock.js"></script>
    <script src="./exporting.js"></script>
    <script src="./zh_cn-1.4.0.min.js"></script>
</head>
<style>
    body {
        padding: 0;
        margin: 0;
    }
    html,body{
        height: 100%;
        width: 100%;
    }
    html{
        height: 100%;
        width: 100%;
    }

    /*#container{*/
    /*    position: fixed;*/
    /*    width: 1px;*/
    /*    height: 400px;*/
    /*    margin: auto;*/
    /*    background-color: white;*/
    /*    top: 0;*/
    /*    left: 0;*/
    /*    right: 0;*/
    /*    bottom: 0;*/
    /*}*/
</style>

<body>
<div id="container" style="width: 100%; height: 90%"></div>
<script>
    // 访问路径：file:///C:/python_project/gp_crawler/myspider/myspider/5.html?days=12
    // 入参: days： 取正常日的天数的范围
    //      type： 为0时，将每个数据点的值与第一个数据点的值进行比较，并以百分比形式显示相对变化；为1时：计算当前点与前一个点的变化百分比
    var currentUrl = window.location.href;

    // 使用 URL 对象解析 URL
    var url = new URL(currentUrl);

    // 使用 URLSearchParams 获取参数
    var params = new URLSearchParams(url.search);

    // 获取特定参数的值
    var days = params.get('days');
    var showtype = params.get('type');

    var seriesOptions = [];

    var chart = null
    var selectedPoint = null

    if (!days) {
        alert("缺少days")
    }
    // create the chart when all data is loaded
    var createChart = function () {
        return Highcharts.stockChart('container', {
            chart: {
                /*
                'line'：折线图
                'column'：柱状图
                'bar'：横向柱状图
                'area'：面积图
                'areaspline'：平滑面积图
                'scatter'：散点图

                */
                type: 'line',
                events: {
                    load: function () {
                        // 在图表加载后，将焦点设置在第一个点上
                        this.series[0].points[0].select();
                    }
                }
            },

            // 图例配置
            legend: {
                enabled: false, // 设置为 true 以启用图例，默认为 true
                align: 'center', // 图例的水平对齐方式：'left', 'center', 'right'
                verticalAlign: 'top', // 图例的垂直对齐方式：'top', 'middle', 'bottom'
                layout: 'horizontal', // 图例的布局方式：'horizontal'（水平）或 'vertical'（垂直）
                borderWidth: 1, // 图例边框的宽度
                borderRadius: 5, // 图例边框的圆角半径
                borderColor: '#ccc', // 图例边框的颜色
                itemStyle: {
                    color: '#333' // 图例项的文本颜色
                },
                itemHoverStyle: {
                    color: '#000' // 图例项的悬停时文本颜色
                },
                // labelFormatter: function () {
                //     return this.name + ' <span class="toggle" onclick="toggleSeries(\'' + this.name + '\')">Toggle</span>';
                // }
                itemEvents: {
                    legendItemClick: function () {
                        var series = this.chart.series;
                        var index = this.index;
                        var isVisible = series[index].visible;

                        series.forEach(function (s) {
                            s.setVisible(!isVisible, false);
                        });
                    }
                }
            },
            rangeSelector: {
                selected: 4
            },
            yAxis: {
                labels: {
                    formatter: function () {
                        return (this.value > 0 ? ' + ' : '') + this.value + '%';
                    }
                },
                plotLines: [{
                    value: 0,
                    width: 2,
                    color: 'silver'
                }]
            },
            plotOptions: {
                series: {
                    dataLabels: {
                        enabled: false,
                        formatter: function() {
                            console.log('Current Y value:', this);
                            // 使用 Highcharts.numberFormat 格式化数值，保留两位小数
                            if (showtype == 1) {
                                return Highcharts.numberFormat(this.y, 2) + '%';
                            } else {
                                return Highcharts.numberFormat(this.point.change, 2) + '%';
                            }
                        }
                    },
                     events: {
                        mouseOver: function () {
                            // 当悬停时显示数据标签
                            this.update({
                                dataLabels: {
                                    enabled: true
                                }
                            });
                        },
                        mouseOut: function () {
                            // 当鼠标离开时隐藏数据标签
                            this.update({
                                dataLabels: {
                                    enabled: false
                                }
                            });
                        }
                    },
                    compare: showtype == 1 ? 'none' : "percent", //percent、none、value、percentchange
                    point: {
                        cursor: 'pointer',
                        events: {
                            click: function (event) {
                                console.log("当前this.series", this.series)
                                console.log("当前point", event.point)
                                selectedPoint = event.point
                                // var currentIndex = selectedPoint.index; // x轴的index
                                // var currentPlotY = selectedPoint.plotY
                                // // 获取左边点的索引
                                // var leftIndex = currentIndex - 1;
                                // var leftPoint = this.series.data[leftIndex];
                                // console.log("左边point", leftPoint)
                                //
                                //
                                // seriesOptionsLength = seriesOptions.length
                                // var currColumns = [];
                                // for (var i = 0; i < seriesOptionsLength; i++) {
                                //     currColumns.push({"seriesIndex": i, "plotY": chart.series[i].data[currentIndex].plotY, "point": chart.series[i].points[currentIndex]});
                                // }
                                //
                                // console.log("currColumns=", currColumns)
                                // //
                                // var sortedCurrColumns = currColumns.slice().sort((a, b) => parseFloat(a.plotY) - parseFloat(b.plotY));
                                // console.log("sortedCurrColumns=", sortedCurrColumns)
                                // var sortedCurrColumnsIndex = sortedCurrColumns.findIndex(item => item.plotY === currentPlotY);
                                // var targetIndex = Math.min(sortedCurrColumnsIndex + 1, seriesOptionsLength - 1);
                                // var targetPoint = sortedCurrColumns[targetIndex].point
                                // console.log(targetPoint)
                                // // 移动选中点
                                // selectedPoint.select(false); // 取消当前点的选择
                                // selectedPoint = targetPoint;
                                // selectedPoint.select(); // 选中新的点x
                                // chart.tooltip.refresh(targetPoint)
                                // // var colNextSeriesIndex = sortedCurrColumns[nextIndex].seriesIndex

                            }
                        }
                    }
                },

            },
            tooltip: {
                pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.change}%)<br/>',
                valueDecimals: 2
            },
            series: seriesOptions
        });
    };

    // console.log(name + "===", data)
    // var data = {
    //     "data": {
    //         "industry_name_daily_data": {
    //             'A': [111, 116, 134, 120, 121],
    //             'B': [124, 111, 134, 125, 121],
    //             'C': [0, 0, 0, 120, 110, 110],
    //         },
    //         "date_list":[20230101, 20230102, 20230103, 20230104, 20230105, ]
    //     }
    // }


    $.getJSON('http://127.0.0.1:5000/api/industry_daily_data_v2?days='+days, function (data) {
        console.log(data)
        var i = 0;
        for(var name in data.data.industry_name_daily_data) {
            console.log(name)
            console.log(data.data.industry_name_daily_data[name])
            var seriesdata = []
            if (showtype == 1) {
                 // 计算前后百分比变化
                 seriesdata = data.data.industry_name_daily_data[name].map(function (point, index, array) {
                    if (index === 0) {
                        return [point[0], 0]; // 第一个点的变化为0
                    } else {
                        var previousValue = array[index - 1][1];
                        var percentageChange = ((point[1] - previousValue) / previousValue) * 100;
                        return [point[0], percentageChange];
                    }
                });
            } else {
                seriesdata = data.data.industry_name_daily_data[name]
            }
            seriesOptions[i] = {
                name: name + i,
                data: seriesdata
            };
            i++;
        }
        chart = createChart();
        // 当前选中的点
        selectedPoint = chart.series[0].points[0];
    });


    // $.each(names, function (i, name) {
    //     $.getJSON('https://data.jianshukeji.com/jsonp?filename=json/' + name.toLowerCase() + '-c.json&callback=?', function (data) {
    //
    //     });
    // });
    function toggleAllSeries() {
        console.log(chart)
        var series = chart.series;
        var allVisible = series.every(function (s) {
            return s.visible;
        });

        series.forEach(function (s) {
            s.setVisible(!allVisible, false);
        });
    }



    // 监听键盘事件
    document.addEventListener('keydown', function (event) {
        console.log(chart.series)
        var currentIndex = selectedPoint.index; // x轴的index
        console.log("currentIndex==", currentIndex)
        var currentPlotY = selectedPoint.plotY
        var seriesOptionsLength = seriesOptions.length
        var xLength = chart.series[0].data.length
        console.log("xLength=", xLength)
        var currColumns = [];
        for (var i = 0; i < seriesOptionsLength; i++) {
            currColumns.push({"seriesIndex": i, "plotY": chart.series[i].data[currentIndex].plotY, "point": chart.series[i].data[currentIndex]});
        }
        console.log("currColumns=", currColumns)
        var sortedCurrColumns = currColumns.slice().sort((a, b) => parseFloat(a.plotY) - parseFloat(b.plotY));
        console.log("sortedCurrColumns=", sortedCurrColumns)
        var sortedCurrColumnsIndex = sortedCurrColumns.findIndex(item => item.plotY === currentPlotY);

        var targetPoint = null
        switch (event.key) {
            case 'ArrowUp':
                // console.log("selectedPoint==", selectedPoint)
                // return
                var targetColumnIndex = Math.min(sortedCurrColumnsIndex - 1, xLength - 1);
                // targetPoint = selectedPoint.series.data[targetXIndex]

                targetPoint = sortedCurrColumns[targetColumnIndex].point
                console.log(targetPoint)
                break;
            case 'ArrowDown':
                var targetColumnIndex = Math.min(sortedCurrColumnsIndex + 1, xLength - 1);
                targetPoint = sortedCurrColumns[targetColumnIndex].point
                console.log(targetPoint)
                break;
            case 'ArrowLeft':
                var targetXIndex = Math.max(currentIndex - 1, 0);
                targetPoint = selectedPoint.series.data[targetXIndex]

                console.log(targetPoint)
                break;
            case 'ArrowRight':
                var targetXIndex = Math.min(currentIndex + 1, xLength - 1);
                console.log("targetXIndex=", targetXIndex)
                targetPoint = selectedPoint.series.data[targetXIndex]
                console.log("目标targetpoint====", targetPoint)
                break;
        }
        if (targetPoint) {
            // 移动选中点
            selectedPoint.select(false); // 取消当前点的选择
            selectedPoint = targetPoint;
            selectedPoint.select(); // 选中新的点x
            chart.tooltip.refresh(selectedPoint)
        }
    });
</script>
<input type="checkbox" id="selectAll" onchange="toggleAllSeries()">
<label for="selectAll">全选/反选</label>

</body>
</html>